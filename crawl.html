<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>One-Click Crawl</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        button {padding:.8rem 1.5rem; font-size:1rem; margin:1rem;}
    </style>
</head>
<body>

<button id="crawlBtn">Crawl Wikipedia Page(Q4 2025)</button>
<pre id="output"></pre>

<script>
    
/* --------------------------------------------------------------
   1. Crawler function (stringified & injected)
   -------------------------------------------------------------- */
const CRAWLER_SRC = `
(function findRowsWithDate(selector) {
    const debug = false;
    const monthes = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const header = ['time', 'rocket',  'mission', 'site', 'org'];
    const noOp = x => x;
    const takeInfo = x => x ? x.info: x;
    const timeTrans = t => {
      try {
        //console.log('Before:', t);
        const cleanStr = t.replace(/\[\d+\]/g, ''); 
        //console.log('after:', cleanStr);
        return cleanStr.replace(/(\d{1,2}\s+[A-Za-z]+)(\d{2}:\d{2})/, '$1 $2');
      } catch (error) {
        console.error("could not prase time as: " + JSON.stringify(t));
        return t;
      }
    };
    const transform = [timeTrans,takeInfo, noOp, takeInfo, noOp];
    let json = [];

    // Array to store matching rows
    const matchingRows = [];
    
    // Select table
    const $tables = $(`\\b${selector}\\b`)
    if (!$tables.length) {
        console.error('Table not found');
        return matchingRows;
    }
    console.log(`Found ${$tables.length} tables`);
    // Iterate on each table
    // Iterate through each row
    let cnt =1;
    let upcomming = false;
    $tables.each(function() {
      
      let subOrbital = false;
      let hasNormalData = false;
      
      let $table = $(this);
      // check if its upcoming or suborbital table
      $table.find('tr').each(function() {
        const $row = $(this);
          // Check if any td in the row contains a date
          const $tds = $row.find('td');
          if(!upcomming) {
            //once upcoming, ignore all the rest.
            upcomming = $tds.is(function() {
              return $(this).text().includes('Upcoming launches');
            });
          } 
          if(!subOrbital) {
          subOrbital = $tds.is(function() {
              return $(this).text().includes('Suborbital');
          });
        }
          // normla data only from not upcoming or subortibal process
          if(!hasNormalData) {
          hasNormalData = !upcomming && !subOrbital &&  $tds.length > 2 && $tds.first().is(function() {
              const textContent = this.innerText;
              //return monthes.some(m => $(this).text().includes('April'));
              return monthes.some(m => new RegExp(`\\b${m}\\b`).test(textContent));
          });
        }
      });
      //early return for only subOrbital or upcoming
      if(!hasNormalData && (upcomming || subOrbital)) {
            console.log('ignore only upcommings or subOrbital:'+cnt);
            return false;
      }
      subOrbital = false;
      upcomming = false;
      // process table (might still have mixed with upcoming or subOrbital)
      $table.find('tr').each(function() {
          const $row = $(this);
          // Check if any td in the row contains a date
          const $tds = $row.find('td');
          // eager return if processed to upcoming or suborbital
          if((upcomming || subOrbital)) {
            console.log('ignore upcommings or subOrbital inner:'+cnt);
            return false;
          }

          upcomming = $tds.is(function() {
              return $(this).text().includes('Upcoming launches');
          });

          subOrbital = $tds.is(function() {
              return $(this).text().includes('Suborbital');
          });

          if((upcomming || subOrbital)) {
            console.log('ignore upcommings or subOrbital:'+cnt);
            return false;
          }
          
          const hasDate = $tds.length > 2 && $tds.first().is(function() {
              const textContent = this.innerText;
              //return monthes.some(m => $(this).text().includes('April'));
              return monthes.some(m => new RegExp(`\\b${m}\\b`).test(textContent));
          });
          if (hasDate) { // row has date, indicate a valid row 
              // Push an array of all td texts
              const tdTexts = $tds.map(function() {
                const textContent = $(this).text().trim()
                  // there are multiple possible columns having flag icon
                  const targetLink = $(this).find('span.flagicon a').first();
                  
                  if(targetLink && targetLink.length > 0) {
                    //console.log({country: targetLink.attr('title') || targetLink.text(), info: textContent.trim()});
                    return {country: targetLink.attr('title') || targetLink.text(), info: textContent.trim()};
                  }
                  else if(textContent.includes('img')) {
                    // img tag 
                    // Regex to match the alt attribute
                    const altRegex = /alt="([^"]*)"/;
                    // Regex to match the text after the closing img tag
                    const textRegex = />([^<]+)$/;

                    // Extract alt
                    const altMatch = textContent.match(altRegex);
                    const alt = altMatch ? altMatch[1] : '';

                    // Extract text
                    const textMatch = textContent.match(textRegex);
                    const text = textMatch ? textMatch[1].trim() : '';
                    return {country: alt, info: text};
                  }
                  return {info:textContent};
              }).get();

              matchingRows.push(tdTexts);
              const obj = {};
              obj['flight']=cnt; cnt++;
              for(var j =0;j<header.length;j++) {
                let info;
                if(header[j] =='org') {
                  info = tdTexts[j]
                } else {
                  info = tdTexts[j].info;
                }
                obj[header[j]] = transform[j](info);
              }
              json.push(JSON.stringify(obj));
          }
      });
    });
    // download
    const finalContent = `[${json.join(',\n')}]`;
    if(debug) {
      console.log(finalContent);
    }
// Create a Blob with the CSV content
  const blob = new Blob([finalContent], { type: 'application/json;charset=utf-8;' });

  // Create a temporary link to trigger download
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  if(!debug) {
    link.setAttribute('href', url);
  }
  link.setAttribute('download', 'world_launches_q4.json'); // File name
  link.style.display = 'none';

  // Append link to body, trigger click, and remove
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
})('.wikitable')
`;

const dataUrl = (wikiUrl) =>  'data:text/html,' + encodeURIComponent(`
            <!DOCTYPE html>
            <html><head>
              <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
              <script>${EXTRACTOR_SCRIPT}</script>
            </head><body>
              <h3>Loading Wikipedia...</h3>
              <script>
                setTimeout(() => location.href = "${wikiUrl}", 100000);
              </script>
            </body></html>
        `);



/* --------------------------------------------------------------
   2. Main driver â€“ reusable function
   -------------------------------------------------------------- */
    function crawlTarget(wikiUrl) {
        $('#status').text('Opening secure tab...');

        // Step 1: Open blank data: URL
        
        dataUrlStr = dataUrl(wikiUrl);
        console.log(dataUrlStr);
        const tab = window.open(dataUrlStr, '_blank');
        if (!tab) {
            alert('Pop-up blocked! Allow pop-ups for this site.');
            return;
        }

        // Listen for completion
        const listener = (e) => {
            if (e.data && e.data.type === 'CRAWL_DONE') {
                window.removeEventListener('message', listener);
                $('#status').html(`<strong>Success!</strong> ${e.data.count} launches downloaded.`);
            }
        };
        window.addEventListener('message', listener);

        $('#status').text('Wikipedia loading...');
    }

/* --------------------------------------------------------------
   3. Button wiring
   -------------------------------------------------------------- */
    $('#crawlBtn').on('click', () => {
        const url = 'https://en.m.wikipedia.org/wiki/List_of_spaceflight_launches_in_October%E2%80%93December_2025#October'; // change as needed

        crawlTarget(url, {
            onResult: (data) => {
                const out = data
                    ? `href: ${data.href}\nTitle: ${data.title}\nCountry: ${data.countryName}`
                    : 'No flag link found';
                $('#output').text(out);
            }
        });
});
</script>

</body>
</html>